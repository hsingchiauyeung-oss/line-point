<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›†é»å¡</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* === UI è¨­è¨ˆ === */
    body { font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; text-align: center; color: #333; }
    .card { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
    h2 { margin: 0; font-size: 16px; color: #888; letter-spacing: 1px;}
    #points { font-size: 72px; font-weight: bold; color: #00C300; margin: 10px 0; line-height: 1; }
    
    /* æŒ‰éˆ• */
    .btn { display: block; width: 100%; padding: 16px 0; border-radius: 12px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.1s; }
    .btn-draw { background-color: #ff9800; color: white; box-shadow: 0 4px 0 #e68900; }
    .btn-draw:active { box-shadow: 0 2px 0 #e68900; transform: translateY(2px); }
    .btn-draw:disabled { background-color: #ddd; color: #999; box-shadow: none; cursor: default; transform: none; }
    .btn-history { background-color: #fff; color: #555; border: 1px solid #ddd; margin-top: 15px; font-size: 16px; padding: 12px 0;}
    
    /* è½‰ç›¤é®ç½© */
    #wheelModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    #wheelStatus { color: white; font-size: 20px; margin-top: 25px; letter-spacing: 1px;}
    #pointer { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 35px solid #ff3333; z-index: 10; }

    /* æ­·å²ç´€éŒ„èˆ‡æ ¸éŠ· */
    #historySection { margin-top: 30px; text-align: left; display: none; border-top: 1px solid #eee; padding-top: 15px; }
    .history-item { padding: 12px 0; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; align-items: center; }
    .tag { padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-right: 8px; font-weight: bold;}
    .tag-scan { background: #e6f7ff; color: #1890ff; }
    .tag-draw { background: #fff1f0; color: #f5222d; }
    .btn-redeem { background: #00C300; color: white; border: none; padding: 6px 14px; border-radius: 20px; font-size: 13px; }
    
    /* æ ¸éŠ·å½ˆçª— */
    #redeemModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .redeem-box { background: white; width: 80%; max-width: 300px; padding: 25px; border-radius: 12px; text-align: center; }
    .code-text { font-size: 24px; font-weight: bold; background: #f0f0f0; padding: 10px; margin: 15px 0; display: block; border-radius: 8px; color: #333; letter-spacing: 2px;}

    /* è®€å–ä¸­é®ç½© */
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 3000; flex-direction: column; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #00C300; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading">
    <div class="loading-spinner"></div>
    <div style="color:#666; font-size:14px;">è³‡æ–™è¼‰å…¥ä¸­...</div>
  </div>

  <div id="wheelModal">
    <div style="position: relative;">
      <div id="pointer"></div>
      <canvas id="wheelCanvas" width="300" height="300"></canvas>
    </div>
    <div id="wheelStatus">æº–å‚™æ—‹è½‰...</div>
  </div>

  <div id="redeemModal">
    <div class="redeem-box">
      <h3 style="margin:0 0 10px 0;">ğŸ‰ å…Œæ›æˆåŠŸ</h3>
      <div style="font-size:14px; color:#666;">è«‹å‡ºç¤ºæˆ–æˆªåœ–æ­¤ä»£ç¢¼</div>
      <span class="code-text" id="redeemCodeDisplay">...</span>
      <button onclick="document.getElementById('redeemModal').style.display='none'" style="background:#666; color:white; border:none; padding:10px 30px; border-radius:20px;">é—œé–‰</button>
    </div>
  </div>

  <div class="card">
    <h2>ç¾æœ‰é»æ•¸</h2>
    <div id="points">--</div>
    
    <button id="btnDraw" class="btn btn-draw" disabled onclick="handleDraw()">
      Loading...
    </button>
    
    <button class="btn btn-history" onclick="toggleHistory()">
      ç´€éŒ„èˆ‡å…Œæ›
    </button>

    <div id="historySection">
      <div id="historyList"></div>
    </div>
  </div>

  <script>
    // ===================================
    // â˜… è«‹å¡«å…¥æ‚¨çš„è³‡è¨Š
    // ===================================
    const LIFF_ID = "2009057632-82QgHeXo"; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxrxI-wVr2azto-NM505H50lxhf4Bpctvvkbmn9JccXV7fN9pCLPIdtUV3Uhf_jWQBVtw/exec"; 
    // ===================================

    let currentUserId = null;
    let currentPoints = 0;
    
    // è½‰ç›¤åƒæ•¸
    const prizes = ["Aè³", "Bè³", "Cè³"];
    const colors = ["#FF6384", "#36A2EB", "#FFCE56"]; 
    let startAngle = 0;
    let arc = Math.PI / (prizes.length / 2);
    let ctx;
    
    // åˆå§‹åŒ–
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) liff.login();
      else {
        liff.getProfile().then(profile => {
          currentUserId = profile.userId;
          // åˆ¤æ–·æ˜¯æƒç¢¼é€²ä¾†é‚„æ˜¯å–®ç´”æ‰“é–‹
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get('code');
          if (code) {
             callBackend("scan", { code: code });
             window.history.replaceState({}, document.title, window.location.pathname);
          } else {
             callBackend("init", {});
          }
          drawStaticWheel(); // å…ˆç•«å¥½è½‰ç›¤å‚™ç”¨
        });
      }
    });

    // æ ¸å¿ƒ API å‘¼å«
    function callBackend(action, payload) {
      // é¡¯ç¤ºè®€å–ç‹€æ…‹ (é™¤äº†æŠ½çï¼Œå› ç‚ºæŠ½çæœ‰è‡ªå·±çš„ç‹€æ…‹)
      if(action !== 'draw') document.getElementById('loading').classList.remove('hidden');

      const data = { action: action, userId: currentUserId, ...payload };
      
      fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(response => {
        if(action !== 'draw') document.getElementById('loading').classList.add('hidden');

        if (response.status === "fatal_error") {
            alert("ç³»çµ±ç¶­è­·ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦");
            return;
        }

        // æ›´æ–°é»æ•¸é¡¯ç¤º
        if (response.points !== undefined) {
            currentPoints = response.points;
            updateUI(currentPoints);
        }
        
        // æ›´æ–°æ­·å²ç´€éŒ„
        if (response.history !== undefined) {
            renderHistory(response.history);
        }

        // è™•ç†å„å‹•ä½œçš„çµæœ
        if (action === "scan") {
            if(response.status === 'success') alert("é›†é»æˆåŠŸï¼");
            else alert(response.message);
        }
        else if (action === "redeem") {
            if(response.status === 'success') {
                document.getElementById('redeemCodeDisplay').innerText = response.code;
                document.getElementById('redeemModal').style.display = 'flex';
                // åˆ·æ–°åˆ—è¡¨ä»¥é¡¯ç¤ºå·²å…Œæ›
                callBackend("init", {}); 
            }
        }
        else if (action === "draw") {
            // â˜… æŠ½ççš„å›å‚³è™•ç†
            const btn = document.getElementById('btnDraw');
            if(response.status === 'success') {
                // æˆåŠŸï¼šå•Ÿå‹•è½‰ç›¤
                startSpinning(response.prize);
            } else {
                // å¤±æ•—ï¼šå¾©åŸæŒ‰éˆ•
                alert(response.message);
                updateUI(currentPoints); // å¾©åŸæŒ‰éˆ•æ–‡å­—
            }
        }
      })
      .catch(err => {
        document.getElementById('loading').classList.add('hidden');
        alert("ç¶²è·¯é€£ç·šä¸ç©©ï¼Œè«‹é‡è©¦");
        if(action === 'draw') updateUI(currentPoints);
      });
    }

    // === æŠ½çèˆ‡è½‰ç›¤é‚è¼¯ (ç©©å®šç‰ˆ) ===
    
    function handleDraw() {
        if(!confirm("ç¢ºå®šæ¶ˆè€— 10 é»æŠ½çï¼Ÿ")) return;
        
        // 1. é–å®šæŒ‰éˆ•ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“ç³»çµ±æ­£åœ¨è™•ç†
        const btn = document.getElementById('btnDraw');
        btn.disabled = true;
        btn.innerHTML = "â³ æº–å‚™çå“ä¸­..."; // çµ¦äºˆæ˜ç¢ºå›é¥‹
        btn.style.backgroundColor = "#999";
        
        // 2. å‘¼å«å¾Œç«¯ (é€™æ™‚å€™é‚„ä¸é¡¯ç¤ºè½‰ç›¤ï¼Œé¿å…ç©ºè½‰)
        callBackend("draw", {});
    }

    function startSpinning(targetPrize) {
        // 3. å¾Œç«¯æˆåŠŸå›å‚³çå“å¾Œï¼Œæ‰é¡¯ç¤ºè½‰ç›¤
        document.getElementById('wheelModal').style.display = 'flex';
        document.getElementById('wheelStatus').innerText = "å¹¸é‹è½‰ç›¤è½‰å‹•ä¸­...";
        
        // è¨ˆç®—ç›®æ¨™è§’åº¦
        const prizeIndex = prizes.indexOf(targetPrize);
        // æ¯å€‹æ‰‡å½¢çš„è§’åº¦
        const degreePerSlice = (2 * Math.PI) / prizes.length;
        // ç‚ºäº†è®“æŒ‡é‡(270åº¦/1.5PI)æŒ‡å‘è©²æ‰‡å½¢ä¸­å¿ƒ
        const centerOffset = (prizeIndex * degreePerSlice) + (degreePerSlice / 2);
        let targetRad = (1.5 * Math.PI) - centerOffset;
        
        // åŠ ä¸Šéš¨æ©Ÿåœˆæ•¸ (è‡³å°‘ 5 åœˆ)
        const totalRad = targetRad + (Math.PI * 2 * 5) + (Math.random() * 0.1); 
        
        // åŸ·è¡Œ CSS æˆ– JS å‹•ç•«
        // é€™è£¡æˆ‘å€‘ç”¨ç°¡å–®çš„ JS å‹•ç•«ä¾†ç¢ºä¿æ§åˆ¶æ¬Š
        let currentRad = startAngle;
        let startTime = null;
        const duration = 4000; // è½‰ 4 ç§’

        function animate(time) {
            if (!startTime) startTime = time;
            const progress = (time - startTime) / duration;
            
            if (progress < 1) {
                // Easing function (easeOutCubic)
                const ease = 1 - Math.pow(1 - progress, 3);
                const currentAngle = startAngle + (totalRad - startAngle) * ease;
                drawWheel(currentAngle);
                requestAnimationFrame(animate);
            } else {
                // åœæ­¢
                drawWheel(totalRad);
                startAngle = totalRad % (Math.PI * 2); // ç´€éŒ„æœ€å¾Œè§’åº¦
                
                setTimeout(() => {
                    alert("æ­å–œç²å¾—ï¼š" + targetPrize);
                    document.getElementById('wheelModal').style.display = 'none';
                    updateUI(currentPoints); // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                }, 500);
            }
        }
        requestAnimationFrame(animate);
    }

    function drawStaticWheel() {
        drawWheel(startAngle);
    }

    function drawWheel(angle) {
      const canvas = document.getElementById("wheelCanvas");
      if (!canvas.getContext) return;
      ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, 300, 300);
      
      const cx = 150, cy = 150, r = 140;

      for(let i = 0; i < prizes.length; i++) {
        const sliceAngle = angle + i * arc;
        ctx.fillStyle = colors[i];
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, sliceAngle, sliceAngle + arc);
        ctx.lineTo(cx, cy);
        ctx.fill();
        
        // æ–‡å­—
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(sliceAngle + arc/2);
        ctx.fillStyle = "white";
        ctx.font = "bold 20px Arial";
        ctx.fillText(prizes[i], 60, 10);
        ctx.restore();
      }
    }

    // === UI æ›´æ–° ===
    
    function updateUI(points) {
        document.getElementById('points').innerText = points;
        const btn = document.getElementById('btnDraw');
        btn.style.backgroundColor = ""; // æ¸…é™¤ç°è‰²
        
        if (points >= 10) {
            btn.disabled = false;
            btn.innerHTML = "ğŸ° æ¶ˆè€— 10 é»æŠ½ç";
            btn.classList.add('btn-draw');
        } else {
            btn.disabled = true;
            btn.innerHTML = `é›†æ»¿ 10 é»å¯æŠ½ç (é‚„å·® ${10-points} é»)`;
            btn.classList.remove('btn-draw');
        }
    }

    function renderHistory(logs) {
        const list = document.getElementById('historyList');
        list.innerHTML = "";
        if(logs.length === 0) { list.innerHTML = "<div style='color:#999;font-size:14px;margin-top:10px;'>å°šç„¡ç´€éŒ„</div>"; return;}
        
        logs.forEach(log => {
            let btnHtml = "";
            if (log.type === "æŠ½ç") {
                if(log.status === "Unclaimed") {
                    btnHtml = `<button class="btn-redeem" onclick="handleRedeem(${log.rowIndex})">é ˜ç</button>`;
                } else {
                    btnHtml = `<span style="color:#999;font-size:12px;">å·²å…Œæ›</span>`;
                }
            }
            
            const tagClass = log.type === "é›†é»" ? "tag-scan" : "tag-draw";
            
            list.innerHTML += `
            <div class="history-item">
                <div style="text-align:left;">
                    <span class="tag ${tagClass}">${log.type}</span>
                    <b>${log.msg}</b>
                    <div style="color:#999;font-size:12px;margin-top:4px;">${log.date}</div>
                </div>
                <div>${btnHtml}</div>
            </div>`;
        });
    }

    function handleRedeem(rowIndex) {
        if(confirm("ç¢ºå®šè¦å…Œæ›å—ï¼Ÿ")) {
            // é¡¯ç¤ºç°¡æ˜“è®€å–
            const btn = event.target;
            btn.innerText = "...";
            callBackend("redeem", { rowIndex: rowIndex });
        }
    }
    
    function toggleHistory() {
        const section = document.getElementById('historySection');
        section.style.display = section.style.display === 'block' ? 'none' : 'block';
    }
  </script>
</body>
</html>
