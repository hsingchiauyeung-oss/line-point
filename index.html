<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¹¸é‹é›†é»å¡</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* === UI è¨­è¨ˆ === */
    body { font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; text-align: center; color: #333; }
    .card { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
    h2 { margin: 0; font-size: 16px; color: #888; letter-spacing: 1px;}
    #points { font-size: 72px; font-weight: bold; color: #00C300; margin: 10px 0; line-height: 1; }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .btn { display: block; width: 100%; padding: 16px 0; border-radius: 12px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.1s; }
    .btn-draw { background-color: #ff9800; color: white; box-shadow: 0 4px 0 #e68900; }
    .btn-draw:active { box-shadow: 0 2px 0 #e68900; transform: translateY(2px); }
    .btn-draw:disabled { background-color: #ddd; color: #999; box-shadow: none; cursor: default; transform: none; }
    .btn-history { background-color: #fff; color: #555; border: 1px solid #ddd; margin-top: 15px; font-size: 16px; padding: 12px 0;}
    
    /* è½‰ç›¤é®ç½© */
    #wheelModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    #wheelStatus { color: white; font-size: 20px; margin-top: 25px; letter-spacing: 1px;}
    #pointer { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 35px solid #ff3333; z-index: 10; }

    /* æ­·å²ç´€éŒ„åˆ—è¡¨ */
    #historySection { margin-top: 30px; text-align: left; display: none; border-top: 1px solid #eee; padding-top: 15px; }
    .history-item { padding: 12px 0; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; align-items: center; }
    .tag { padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-right: 8px; font-weight: bold;}
    .tag-scan { background: #e6f7ff; color: #1890ff; }
    .tag-draw { background: #fff1f0; color: #f5222d; }
    .btn-redeem { background: #00C300; color: white; border: none; padding: 6px 14px; border-radius: 20px; font-size: 13px; cursor: pointer; }
    
    /* æ ¸éŠ·å½ˆçª— (å«æŒ‰éˆ•) */
    #redeemModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .redeem-box { background: white; width: 85%; max-width: 320px; padding: 30px; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .code-text { font-size: 24px; font-weight: bold; background: #f0f0f0; padding: 15px; margin: 20px 0; display: block; border-radius: 8px; color: #333; letter-spacing: 2px; border: 2px dashed #ccc;}

    /* è®€å–ä¸­é®ç½© */
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 3000; flex-direction: column; }
    .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #00C300; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading">
    <div class="loading-spinner"></div>
    <div style="color:#666; font-size:14px;">è³‡æ–™è¼‰å…¥ä¸­...</div>
  </div>

  <div id="wheelModal">
    <div style="position: relative;">
      <div id="pointer"></div>
      <canvas id="wheelCanvas" width="300" height="300"></canvas>
    </div>
    <div id="wheelStatus">æº–å‚™æ—‹è½‰...</div>
  </div>

  <div id="redeemModal">
    <div class="redeem-box">
      <h3 style="margin:0 0 10px 0;">ğŸ‰ å…Œæ›æˆåŠŸ</h3>
      <div style="font-size:14px; color:#666;">è«‹å°‡æ ¸éŠ·ç¢¼å‚³é€çµ¦å®¢æœäººå“¡</div>
      <span class="code-text" id="redeemCodeDisplay">...</span>
      
      <button id="btnSendCode" style="background:#00C300; color:white; border:none; padding:12px 0; border-radius:50px; font-weight:bold; width:100%; margin-bottom:10px; cursor:pointer; font-size:16px; box-shadow: 0 4px 10px rgba(0,195,0,0.3);">
        ğŸ“¤ å‚³é€ä»£ç¢¼çµ¦å®¢æœ
      </button>
      
      <button onclick="document.getElementById('redeemModal').style.display='none'" style="background:transparent; color:#999; border:none; padding:10px; cursor:pointer; font-size:14px; text-decoration: underline;">
        ç¨å¾Œå†å‚³
      </button>
    </div>
  </div>

  <div class="card">
    <h2>ç¾æœ‰é»æ•¸</h2>
    <div id="points">--</div>
    
    <button id="btnDraw" class="btn btn-draw" disabled onclick="handleDraw()">
      Loading...
    </button>
    
    <button class="btn btn-history" onclick="toggleHistory()">
      ç´€éŒ„èˆ‡å…Œæ›
    </button>

    <div id="historySection">
      <div id="historyList"></div>
    </div>
  </div>

  <script>
    // ===================================
    // â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„è³‡è¨Š (æœ€é‡è¦ï¼)
    // ===================================
    const LIFF_ID = "2009057632-82QgHeXo"; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycby1Q1zgRNwfB4Gs-nV1hjWMCT_kIADO0i91zoblt3QOP9Yenw4x3rHlqAC5sz_2J5ahMw/exec"; 
    const LINE_OA_ID = "@539gosmt"; // ä¾‹å¦‚ @123xyz (è¨˜å¾—è¦æœ‰ @)
    // ===================================

    let currentUserId = null;
    let currentPoints = 0;
    
    // è½‰ç›¤åƒæ•¸
    const prizes = ["Aè³", "Bè³", "Cè³"];
    const colors = ["#FF6384", "#36A2EB", "#FFCE56"]; 
    let startAngle = 0;
    let arc = Math.PI / (prizes.length / 2);
    let ctx;
    
    // åˆå§‹åŒ–æµç¨‹
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) liff.login();
      else {
        liff.getProfile().then(profile => {
          currentUserId = profile.userId;
          // åˆ¤æ–·ç¶²å€æœ‰æ²’æœ‰ code åƒæ•¸ (æƒç¢¼é€²å…¥)
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get('code');
          if (code) {
             callBackend("scan", { code: code });
             // æ¸…é™¤ç¶²å€åƒæ•¸é¿å…é‡è¤‡é›†é»
             window.history.replaceState({}, document.title, window.location.pathname);
          } else {
             callBackend("init", {});
          }
          drawStaticWheel(); // é å…ˆç•«å¥½è½‰ç›¤
        });
      }
    });

    // æ ¸å¿ƒå¾Œç«¯é€šè¨Šå‡½å¼
    function callBackend(action, payload) {
      // é™¤äº†æŠ½çä¹‹å¤–ï¼Œéƒ½é¡¯ç¤ºå…¨è¢å¹•è®€å–
      if(action !== 'draw') document.getElementById('loading').classList.remove('hidden');

      const data = { action: action, userId: currentUserId, ...payload };
      
      fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(response => {
        if(action !== 'draw') document.getElementById('loading').classList.add('hidden');

        // éŒ¯èª¤è™•ç†
        if (response.status === "fatal_error") {
            alert("ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦");
            if(action === 'draw') updateUI(currentPoints); // å¾©åŸæŒ‰éˆ•
            return;
        }

        // æ›´æ–°é»æ•¸èˆ‡åˆ—è¡¨
        if (response.points !== undefined) {
            currentPoints = response.points;
            updateUI(currentPoints);
        }
        if (response.history !== undefined) {
            renderHistory(response.history);
        }

        // --- å‹•ä½œåˆ†æµè™•ç† ---
        if (action === "scan") {
            if(response.status === 'success') alert("é›†é»æˆåŠŸï¼");
            else alert(response.message);
        }
        else if (action === "redeem") {
            if(response.status === 'success') {
                const code = response.code;
                document.getElementById('redeemCodeDisplay').innerText = code;
                
                // â˜… è¨­å®šã€Œä¸€éµå‚³é€ã€æŒ‰éˆ•çš„é€£çµ
                const msg = `æ‚¨å¥½ï¼Œæˆ‘è¦å…Œæ›çå“ï¼æ ¸éŠ·ç¢¼ï¼š${code}`;
                // ä½¿ç”¨ LINE URL Scheme è·³è½‰åˆ°èŠå¤©å®¤ä¸¦å¡«å…¥æ–‡å­—
                const url = `https://line.me/R/oaMessage/${LINE_OA_ID}/?${encodeURIComponent(msg)}`;
                
                const btn = document.getElementById('btnSendCode');
                btn.onclick = function() {
                    window.location.href = url;
                };

                // é¡¯ç¤ºå½ˆçª—
                document.getElementById('redeemModal').style.display = 'flex';
                // åˆ·æ–°åˆ—è¡¨ (è®“æŒ‰éˆ•è®Šæˆå·²å…Œæ›)
                callBackend("init", {}); 
            }
        }
        else if (action === "draw") {
            // â˜… æ”¶åˆ°æŠ½ççµæœ
            if(response.status === 'success') {
                // æˆåŠŸï¼šå•Ÿå‹•è½‰ç›¤å‹•ç•«ï¼Œä¸¦å‚³å…¥ç›®æ¨™çå“
                startSpinning(response.prize);
            } else {
                // å¤±æ•—ï¼šè·³å‡ºè­¦å‘Šä¸¦å¾©åŸæŒ‰éˆ•
                alert(response.message);
                updateUI(currentPoints); 
            }
        }
      })
      .catch(err => {
        document.getElementById('loading').classList.add('hidden');
        alert("ç¶²è·¯é€£ç·šä¸ç©©ï¼Œè«‹é‡è©¦");
        if(action === 'draw') updateUI(currentPoints);
      });
    }

    // === è½‰ç›¤é‚è¼¯ (ç©©å®šç‰ˆï¼šå…ˆæ‹¿åˆ°çµæœæ‰è½‰) ===
    
    function handleDraw() {
        if(!confirm("ç¢ºå®šæ¶ˆè€— 10 é»æŠ½çï¼Ÿ")) return;
        
        // 1. é–å®šæŒ‰éˆ•ï¼Œçµ¦äºˆä½¿ç”¨è€…å›é¥‹
        const btn = document.getElementById('btnDraw');
        btn.disabled = true;
        btn.innerHTML = "â³ æº–å‚™çå“ä¸­..."; 
        btn.style.backgroundColor = "#999";
        btn.style.boxShadow = "none";
        btn.style.transform = "none";
        
        // 2. å‘¼å«å¾Œç«¯ (æ­¤æ™‚è½‰ç›¤é‚„ä¸æœƒå‡ºç¾)
        callBackend("draw", {});
    }

    function startSpinning(targetPrize) {
        // 3. å¾Œç«¯æˆåŠŸå›å‚³çå“å¾Œï¼Œé¡¯ç¤ºè½‰ç›¤ä¸¦é–‹å§‹å‹•ç•«
        document.getElementById('wheelModal').style.display = 'flex';
        document.getElementById('wheelStatus').innerText = "å¹¸é‹è½‰ç›¤è½‰å‹•ä¸­...";
        
        // è¨ˆç®—ç›®æ¨™è§’åº¦
        const prizeIndex = prizes.indexOf(targetPrize);
        const degreePerSlice = (2 * Math.PI) / prizes.length;
        // æŒ‡é‡åœ¨ä¸Šæ–¹(1.5PI)ï¼Œæˆ‘å€‘è¦è®“è©²çå“çš„ä¸­å¿ƒè½‰åˆ°ä¸Šæ–¹
        const centerOffset = (prizeIndex * degreePerSlice) + (degreePerSlice / 2);
        let targetRad = (1.5 * Math.PI) - centerOffset;
        
        // åŠ ä¸Šå¤šåœˆæ—‹è½‰ (è‡³å°‘ 5 åœˆ) + éš¨æ©Ÿå¾®èª¿
        const totalRad = targetRad + (Math.PI * 2 * 5) + (Math.random() * 0.1); 
        
        let startTime = null;
        const duration = 4000; // å‹•ç•«æ™‚é–“ 4 ç§’

        function animate(time) {
            if (!startTime) startTime = time;
            const progress = (time - startTime) / duration;
            
            if (progress < 1) {
                // Easing function (easeOutCubic) è®“è½‰ç›¤æ…¢æ…¢åœä¸‹
                const ease = 1 - Math.pow(1 - progress, 3);
                const currentAngle = startAngle + (totalRad - startAngle) * ease;
                drawWheel(currentAngle);
                requestAnimationFrame(animate);
            } else {
                // å‹•ç•«çµæŸ
                drawWheel(totalRad);
                startAngle = totalRad % (Math.PI * 2); // æ›´æ–°ç•¶å‰è§’åº¦
                
                setTimeout(() => {
                    alert("æ­å–œç²å¾—ï¼š" + targetPrize);
                    document.getElementById('wheelModal').style.display = 'none';
                    updateUI(currentPoints); // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                }, 500);
            }
        }
        requestAnimationFrame(animate);
    }

    function drawStaticWheel() {
        drawWheel(startAngle);
    }

    function drawWheel(angle) {
      const canvas = document.getElementById("wheelCanvas");
      if (!canvas.getContext) return;
      ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, 300, 300);
      
      const cx = 150, cy = 150, r = 140;

      for(let i = 0; i < prizes.length; i++) {
        const sliceAngle = angle + i * arc;
        ctx.fillStyle = colors[i];
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, sliceAngle, sliceAngle + arc);
        ctx.lineTo(cx, cy);
        ctx.fill();
        
        // ç¹ªè£½æ–‡å­—
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(sliceAngle + arc/2);
        ctx.fillStyle = "white";
        ctx.font = "bold 20px Arial";
        ctx.fillText(prizes[i], 60, 10);
        ctx.restore();
      }
    }

    // === UI æ›´æ–°èˆ‡æ­·å²ç´€éŒ„ ===
    
    function updateUI(points) {
        document.getElementById('points').innerText = points;
        const btn = document.getElementById('btnDraw');
        btn.style.backgroundColor = ""; 
        btn.style.boxShadow = ""; 
        
        if (points >= 10) {
            btn.disabled = false;
            btn.innerHTML = "ğŸ° æ¶ˆè€— 10 é»æŠ½ç";
            btn.classList.add('btn-draw');
        } else {
            btn.disabled = true;
            btn.innerHTML = `é›†æ»¿ 10 é»å¯æŠ½ç (é‚„å·® ${10-points} é»)`;
            btn.classList.remove('btn-draw');
        }
    }

    function renderHistory(logs) {
        const list = document.getElementById('historyList');
        list.innerHTML = "";
        if(logs.length === 0) { list.innerHTML = "<div style='color:#999;font-size:14px;margin-top:10px;'>å°šç„¡ç´€éŒ„</div>"; return;}
        
        logs.forEach(log => {
            let btnHtml = "";
            if (log.type === "æŠ½ç") {
                if(log.status === "Unclaimed") {
                    btnHtml = `<button class="btn-redeem" onclick="handleRedeem(${log.rowIndex})">é ˜ç</button>`;
                } else {
                    btnHtml = `<span style="color:#999;font-size:12px;">å·²å…Œæ›</span>`;
                }
            }
            const tagClass = log.type === "é›†é»" ? "tag-scan" : "tag-draw";
            list.innerHTML += `
            <div class="history-item">
                <div style="text-align:left;">
                    <span class="tag ${tagClass}">${log.type}</span>
                    <b>${log.msg}</b>
                    <div style="color:#999;font-size:12px;margin-top:4px;">${log.date}</div>
                </div>
                <div>${btnHtml}</div>
            </div>`;
        });
    }

    function handleRedeem(rowIndex) {
        if(confirm("ç¢ºå®šè¦å…Œæ›å—ï¼Ÿ")) {
            // è®“æŒ‰éˆ•é¡¯ç¤ºè®€å–ä¸­
            event.target.innerText = "...";
            callBackend("redeem", { rowIndex: rowIndex });
        }
    }
    
    function toggleHistory() {
        const section = document.getElementById('historySection');
        section.style.display = section.style.display === 'block' ? 'none' : 'block';
    }
  </script>
</body>
</html>

