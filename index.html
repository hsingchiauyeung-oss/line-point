<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¹¸é‹é›†é»å¡</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* === 1. æ•´é«”æ’ç‰ˆæ¨£å¼ === */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; text-align: center; color: #333; }
    .card { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
    h2 { margin: 0; font-size: 18px; color: #666; }
    #points { font-size: 64px; font-weight: bold; color: #00B900; margin: 10px 0; line-height: 1; }
    
    /* === 2. æŒ‰éˆ•æ¨£å¼ === */
    .btn { display: block; width: 100%; padding: 15px 0; border-radius: 50px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.2s; }
    .btn-draw { background-color: #ff9800; color: white; box-shadow: 0 4px 0 #e68900; }
    .btn-draw:active { box-shadow: 0 2px 0 #e68900; transform: translateY(2px); }
    .btn-draw:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }
    .btn-history { background-color: #e4e6eb; color: #333; }
    .btn-redeem { background: #00B900; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; }
    
    /* === 3. æ­·å²ç´€éŒ„åˆ—è¡¨æ¨£å¼ === */
    .status-claimed { color: #999; font-size: 12px; }
    #historySection { margin-top: 25px; text-align: left; display: none; border-top: 1px solid #eee; padding-top: 20px; }
    .history-item { padding: 15px 0; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
    .tag { padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right:5px; }
    .tag-scan { background: #e6f7ff; color: #1890ff; }
    .tag-draw { background: #fff1f0; color: #f5222d; }
    .time { font-size: 12px; color: #999; display:block; margin-top:2px; }

    /* === 4. è½‰ç›¤æ¨¡æ…‹è¦–çª— (å…¨è¢å¹•é®ç½©) === */
    #wheelModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    #canvasContainer { position: relative; margin-bottom: 20px; }
    /* ç´…è‰²æŒ‡é‡ (ä½æ–¼æ­£ä¸Šæ–¹) */
    #pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid #ff3333; z-index: 10; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); }
    #wheelStatus { color: white; font-size: 22px; font-weight: bold; margin-top: 20px; min-height: 30px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);}

    /* === 5. è®€å–ä¸­é®ç½© === */
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 2000; font-weight: bold; flex-direction: column;}
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading">
    <div>ç³»çµ±é€£ç·šä¸­...</div>
    <div style="font-size:12px; color:#999; margin-top:5px;">è«‹ç¨å€™</div>
  </div>

  <div id="wheelModal">
    <div id="canvasContainer">
      <div id="pointer"></div>
      <canvas id="wheelCanvas" width="320" height="320"></canvas>
    </div>
    <div id="wheelStatus">æº–å‚™æŠ½ç...</div>
  </div>

  <div class="card">
    <h2>ç›®å‰ç´¯ç©é»æ•¸</h2>
    <div id="points">--</div>
    
    <button id="btnDraw" class="btn btn-draw" disabled onclick="startDrawFlow()">
      ğŸ° æ¶ˆè€— 10 é»è½‰ç›¤æŠ½ç
    </button>
    
    <button class="btn btn-history" onclick="toggleHistory()">
      æŸ¥çœ‹æ­·å²èˆ‡çå“
    </button>

    <div id="historySection">
      <h3 style="font-size:16px; margin-bottom:10px;">ç´€éŒ„èˆ‡çå“</h3>
      <div id="historyList"></div>
    </div>
  </div>

  <script>
    // ==========================================
    // â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„è³‡æ–™ (é‡è¦ï¼)
    // ==========================================
    const LIFF_ID = "2009057632-82QgHeXo";  // æ–°å»ºç«‹çš„é‚£å€‹
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxDQHIvEYTxFKn54CMzh9cJ_5-ZcMMo1cX1ffYfRvccO4FfYK25Rt7Vj7jwLjnF-dQU2A/exec"; // éƒ¨ç½²å¾Œçš„ exec ç¶²å€
    const LINE_OA_ID = "@539gosmt"; // ä¾‹å¦‚ @123xyz
    // ==========================================

    let currentUserId = null;
    
    // === è½‰ç›¤åƒæ•¸è¨­å®š ===
    const prizes = ["Aè³", "Bè³", "Cè³"]; // å¿…é ˆè·Ÿå¾Œç«¯ GAS çš„çå“åç¨±å®Œå…¨ä¸€è‡´
    const colors = ["#FF6384", "#36A2EB", "#FFCE56"]; // å°æ‡‰çš„é¡è‰²
    
    // å‹•ç•«æ§åˆ¶è®Šæ•¸
    let startAngle = 0; // è½‰ç›¤ç•¶å‰è§’åº¦ (å¼§åº¦)
    let arc = Math.PI / (prizes.length / 2);
    let spinTimeout = null;
    let spinTime = 0;
    let spinTimeTotal = 0;
    let targetRotation = 0; // ç›®æ¨™ç¸½æ—‹è½‰è§’åº¦ (åº¦)
    let initialRotation = 0; // èµ·å§‹è§’åº¦ (åº¦)
    
    let ctx;
    let finalPrize = ""; // å¾Œç«¯å›å‚³çš„æœ€çµ‚çå“

    // 1. LIFF åˆå§‹åŒ–æµç¨‹
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        liff.getProfile().then(profile => {
          currentUserId = profile.userId;
          mainLogic(); // é–‹å§‹åŸ·è¡Œä¸»ç¨‹å¼
          drawRouletteWheel(); // å…ˆç•«å‡ºéœæ…‹è½‰ç›¤
        });
      }
    }).catch(err => {
      alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID æ˜¯å¦æ­£ç¢º");
      document.getElementById('loading').classList.add('hidden');
    });

    // 2. ä¸»é‚è¼¯åˆ¤æ–· (é›†é» vs æŸ¥è©¢)
    function mainLogic() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        // æœ‰ code ä»£è¡¨æ˜¯æƒæ QR code é€²ä¾†çš„
        document.getElementById('loading').innerHTML = "é›†é»è™•ç†ä¸­...";
        callBackend("scan", { code: code });
        // æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œé¿å…é‡æ–°æ•´ç†æ™‚é‡è¤‡é›†é»
        window.history.replaceState({}, document.title, window.location.pathname);
      } else {
        // æ²’æœ‰ code ä»£è¡¨æ˜¯å¾åœ–æ–‡é¸å–®é€²ä¾†çš„
        callBackend("init", {});
      }
    }

    // 3. å¾Œç«¯ API å‘¼å«å‡½å¼
    function callBackend(action, payload) {
      const data = { action: action, userId: currentUserId, ...payload };
      
      // å¦‚æœä¸æ˜¯æŠ½ç (æŠ½çæœ‰è‡ªå·±çš„è½‰ç›¤ loading)ï¼Œå°±é¡¯ç¤ºå…¨è¢å¹•è®€å–
      if(action !== 'draw') document.getElementById('loading').classList.remove('hidden');

      fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(text => JSON.parse(text))
      .then(response => {
        document.getElementById('loading').classList.add('hidden');
        
        // éŒ¯èª¤è™•ç†
        if (response.status === "fatal_error") return alert("ç³»çµ±éŒ¯èª¤ï¼š" + response.message);

        // æ›´æ–°ä»‹é¢æ•¸æ“š
        if (response.points !== undefined) updateUI(response.points);
        if (response.history !== undefined) renderHistory(response.history);

        // é‡å°ä¸åŒå‹•ä½œçš„å¾ŒçºŒè™•ç†
        if (action === "scan") {
            alert(response.message);
        }
        else if (action === "redeem") {
            handleRedeemResponse(response, payload.prizeName);
        }
        else if (action === "draw") {
          if (response.status === "success") {
             // â˜… é—œéµï¼šæ‹¿åˆ°å¾Œç«¯çµæœï¼Œé–‹å§‹è¨ˆç®—ä¸¦è½‰å‹•è½‰ç›¤
             finalPrize = response.prize; 
             calculateTargetAndSpin(finalPrize);
          } else {
             alert(response.message); // é»æ•¸ä¸è¶³æˆ–å…¶ä»–éŒ¯èª¤
             closeWheel();
          }
        }
      })
      .catch(err => {
        document.getElementById('loading').classList.add('hidden');
        alert("é€£ç·šå¤±æ•—ï¼š" + err.message);
        closeWheel();
      });
    }

    // ==========================================
    // â˜… è½‰ç›¤æ ¸å¿ƒé‚è¼¯ (ä¿®æ­£ç‰ˆï¼šçµæœå°å‘)
    // ==========================================

    // ç¹ªè£½è½‰ç›¤ç•«é¢
    function drawRouletteWheel() {
      const canvas = document.getElementById("wheelCanvas");
      if (!canvas.getContext) return;
      ctx = canvas.getContext("2d");
      const outsideRadius = 150;
      const textRadius = 110;
      const insideRadius = 0;
      
      ctx.clearRect(0, 0, 320, 320);
      ctx.strokeStyle = "white";
      ctx.lineWidth = 2;
      ctx.font = 'bold 24px sans-serif';

      for(let i = 0; i < prizes.length; i++) {
        const angle = startAngle + i * arc;
        ctx.fillStyle = colors[i];
        
        ctx.beginPath();
        // ç¹ªè£½æ‰‡å½¢ (åœ“å¿ƒ 160, 160)
        ctx.arc(160, 160, outsideRadius, angle, angle + arc, false);
        ctx.arc(160, 160, insideRadius, angle + arc, angle, true);
        ctx.stroke();
        ctx.fill();

        ctx.save();
        ctx.fillStyle = "white";
        // æ–‡å­—å®šä½èˆ‡æ—‹è½‰
        ctx.translate(160 + Math.cos(angle + arc / 2) * textRadius, 
                      160 + Math.sin(angle + arc / 2) * textRadius);
        ctx.rotate(angle + arc / 2 + Math.PI / 2);
        const text = prizes[i];
        ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
        ctx.restore();
      } 
    }

    // æŒ‰ä¸‹æŠ½çæŒ‰éˆ•
    function startDrawFlow() {
      if (!confirm("ç¢ºå®šè¦æ¶ˆè€— 10 é»é€²è¡Œè½‰ç›¤æŠ½çå—ï¼Ÿ")) return;
      // é¡¯ç¤ºé®ç½©
      document.getElementById('wheelModal').style.display = "flex";
      document.getElementById('wheelStatus').innerText = "ç³»çµ±é€£ç·šä¸­...";
      // å‘¼å«å¾Œç«¯æ‰£é»ä¸¦å–å¾—çµæœ
      callBackend("draw", {}); 
    }

    // â˜… è¨ˆç®—ç›®æ¨™è§’åº¦ä¸¦é–‹å§‹æ—‹è½‰
    function calculateTargetAndSpin(prizeName) {
      document.getElementById('wheelStatus').innerText = "ç¥ä½ å¥½é‹ï¼";
      
      // 1. æ‰¾å‡ºè©²çå“åœ¨é™£åˆ—ä¸­çš„ä½ç½® (0, 1, 2...)
      const prizeIndex = prizes.indexOf(prizeName);
      if (prizeIndex === -1) { 
          alert("ç³»çµ±éŒ¯èª¤ï¼šæœªçŸ¥çš„çå“"); 
          closeWheel();
          return; 
      }

      // 2. è¨ˆç®—æ•¸å­¸é‚è¼¯
      // æ¯å€‹æ‰‡å½¢ä½”å¹¾åº¦ (360 / 3 = 120åº¦)
      const degreePerSlice = 360 / prizes.length;
      
      // è©²çå“çš„ä¸­å¿ƒé»åœ¨åœ“ç›¤ä¸Šçš„åŸå§‹è§’åº¦
      // ä¾‹å¦‚ index 0 çš„ä¸­å¿ƒæ˜¯ 60åº¦
      const prizeCenterDegree = (prizeIndex * degreePerSlice) + (degreePerSlice / 2);

      // 3. è¨ˆç®—ä¿®æ­£é‡
      // æŒ‡é‡åœ¨æ­£ä¸Šæ–¹ (270åº¦ä½ç½®)ã€‚æˆ‘å€‘è¦æŠŠã€Œçå“ä¸­å¿ƒã€è½‰åˆ°ã€Œ270åº¦ã€ã€‚
      // å…¬å¼ï¼šç›®æ¨™åç§» = 270 - çå“ä¸­å¿ƒè§’åº¦
      let offset = 270 - prizeCenterDegree;
      
      // 4. è¨­å®šæ—‹è½‰åƒæ•¸
      // ç‚ºäº†åˆºæ¿€æ„Ÿï¼Œè‡³å°‘å¤šè½‰ 5 åœˆ (360 * 5)
      // åŠ å…¥éš¨æ©Ÿå¾®èª¿ (-10 ~ +10åº¦) è®“æŒ‡é‡ä¸æœƒæ¯æ¬¡éƒ½åœåœ¨æ­£ä¸­é–“ï¼Œçœ‹èµ·ä¾†æ¯”è¼ƒè‡ªç„¶
      const randomOffset = Math.floor(Math.random() * 20) - 10;
      const totalDegree = (360 * 5) + offset + randomOffset;

      // 5. è¨­å®šå‹•ç•«ç‹€æ…‹
      initialRotation = startAngle * 180 / Math.PI; // å°‡ç•¶å‰å¼§åº¦è½‰å›è§’åº¦
      targetRotation = initialRotation + totalDegree; // ç›®æ¨™ç¸½è§’åº¦
      spinTime = 0;
      spinTimeTotal = 5000; // å‹•ç•«ç¸½æ™‚é–“ 5ç§’
      
      rotateWheel(); // é–‹å§‹æ’­æ”¾å‹•ç•«
    }

    // å‹•ç•«è¿´åœˆ
    function rotateWheel() {
      spinTime += 20; // æ¯æ¬¡æ›´æ–°åŠ çš„æ™‚é–“
      
      if(spinTime >= spinTimeTotal) {
        stopRotateWheel();
        return;
      }
      
      // ä½¿ç”¨ Easing Function (å…ˆå¿«å¾Œæ…¢) è¨ˆç®—ç•¶å‰è§’åº¦
      const currentDegree = easeOut(spinTime, initialRotation, targetRotation - initialRotation, spinTimeTotal);
      
      // å°‡è§’åº¦è½‰å›å¼§åº¦ä¸¦ç¹ªåœ–
      startAngle = currentDegree * Math.PI / 180;
      drawRouletteWheel();
      
      spinTimeout = requestAnimationFrame(rotateWheel);
    }

    // åœæ­¢æ—‹è½‰ä¸¦é¡¯ç¤ºçµæœ
    function stopRotateWheel() {
      cancelAnimationFrame(spinTimeout);
      
      // å¼·åˆ¶è¨­å®šç‚ºæœ€å¾Œçš„ç›®æ¨™è§’åº¦ (æ¶ˆé™¤æµ®é»æ•¸èª¤å·®)
      startAngle = targetRotation * Math.PI / 180;
      drawRouletteWheel();

      setTimeout(() => {
        alert("ğŸ‰ æ­å–œç²å¾—ï¼š" + finalPrize + "ï¼");
        closeWheel();
        callBackend("init", {}); // é‡æ–°æ•´ç† UI é¡¯ç¤ºæœ€æ–°é»æ•¸
      }, 500);
    }

    // æ•¸å­¸ç·©è¡å…¬å¼ (Ease Out Quart)
    function easeOut(t, b, c, d) {
      const ts = (t/=d)*t;
      const tc = ts*t;
      return b+c*(tc + -3*ts + 3*t);
    }

    function closeWheel() {
      document.getElementById('wheelModal').style.display = "none";
    }

    // ==========================================
    // å…¶ä»– UI èˆ‡ ç¶²è³¼æ ¸éŠ·é‚è¼¯
    // ==========================================

    function updateUI(points) {
      document.getElementById('points').innerText = points;
      const btn = document.getElementById('btnDraw');
      if (points >= 10) {
        btn.disabled = false;
        btn.innerHTML = "ğŸ° æ¶ˆè€— 10 é»è½‰ç›¤æŠ½ç";
      } else {
        btn.disabled = true;
        btn.innerText = `é›†æ»¿ 10 é»å¯æŠ½ç (é‚„å·® ${10 - points} é»)`;
      }
    }

    function renderHistory(logs) {
      const listDiv = document.getElementById('historyList');
      listDiv.innerHTML = "";
      if (logs.length === 0) { 
        listDiv.innerHTML = "<div style='color:#999; text-align:center;'>å°šç„¡ç´€éŒ„</div>"; 
        return; 
      }

      logs.forEach(log => {
        let actionArea = "";
        if (log.type === "æŠ½ç") {
          if (log.status === "Unclaimed") {
            // ç¶å®š onclick äº‹ä»¶ï¼Œå‚³å…¥ row index å’Œçå“åç¨±
            actionArea = `<button class="btn-redeem" onclick="handleRedeem(${log.rowIndex}, '${log.msg}')">é ˜ç</button>`;
          } else if (log.status === "Claimed") {
            actionArea = `<span class="status-claimed">å·²å…Œæ›</span>`;
          }
        }
        const tagClass = log.type === "é›†é»" ? "tag-scan" : "tag-draw";
        const html = `
          <div class="history-item">
            <div style="text-align:left;">
              <span class="tag ${tagClass}">${log.type}</span>
              <span style="font-weight:500;">${log.msg}</span>
              <span class="time">${log.date}</span>
            </div>
            <div>${actionArea}</div>
          </div>`;
        listDiv.innerHTML += html;
      });
    }

    // æŒ‰ä¸‹é ˜çæŒ‰éˆ•
    function handleRedeem(rowIndex, prizeName) {
      if (confirm(`ç¢ºå®šè¦å…Œæ›ã€${prizeName}ã€‘å—ï¼Ÿ\n\nç³»çµ±å°‡ç”¢ç”Ÿæ ¸éŠ·ç¢¼ï¼Œä¸¦å¼•å°æ‚¨å›å‚³çµ¦å®˜æ–¹å¸³è™Ÿã€‚`)) {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('loading').innerHTML = "ç”¢ç”Ÿæ ¸éŠ·ç¢¼ä¸­...";
        callBackend("redeem", { rowIndex: rowIndex, prizeName: prizeName });
      }
    }

    // è™•ç†æ ¸éŠ·å›å‚³çµæœ
    function handleRedeemResponse(response, prizeName) {
      if (response.status === "success") {
        const myCode = response.code; 
        // é è¨­è¦å‚³çµ¦å®˜æ–¹å¸³è™Ÿçš„æ–‡å­—
        const msgToSend = `æ‚¨å¥½ï¼Œæˆ‘è¦å…Œæ›çå“ï¼\nçé …ï¼š${prizeName}\næ ¸éŠ·ç¢¼ï¼š${myCode}\nè«‹å¹«æˆ‘å®‰æ’å‡ºè²¨ã€‚`;
        
        if(confirm(`å…Œæ›æˆåŠŸï¼\næ‚¨çš„æ ¸éŠ·ç¢¼æ˜¯ï¼š${myCode}\n\næ˜¯å¦ç«‹å³å‚³é€çµ¦å®˜æ–¹å¸³è™Ÿï¼Ÿ`)) {
           // ä½¿ç”¨ URL Scheme è·³è½‰åˆ°èŠå¤©å®¤ä¸¦å¸¶å…¥æ–‡å­—
           window.location.href = `https://line.me/R/oaMessage/${LINE_OA_ID}/?${encodeURIComponent(msgToSend)}`;
        }
      } else {
        alert(response.message);
      }
    }

    function toggleHistory() {
      const section = document.getElementById('historySection');
      section.style.display = (section.style.display === "block") ? "none" : "block";
    }
  </script>
</body>
</html>

