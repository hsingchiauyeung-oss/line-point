<hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
    
    <button onclick="loadHistory()" style="background:#0099ff; font-size:16px; padding:10px 20px;">查看歷史紀錄</button>
    
    <div id="historyList" style="margin-top:20px; text-align:left; display:none;">
      <h3>紀錄明細：</h3>
      <ul id="historyUl" style="padding-left: 20px; color:#555;">
        </ul>
    </div>

<script>
    // ... (LIFF init 保持不變) ...

    // 修改 callApi 的 callback 處理邏輯
    function callApi(data) {
      fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(response => {
        
        // 1. 無論成功失敗，如果有回傳 points 就更新 UI (達成：掃描任意 Code 也能看點數)
        if (response.points !== undefined) {
          updateUI(response.points);
        }

        if (response.status === "success") {
          if (data.action === "scan") {
            alert(response.message); // 顯示集點成功
            window.history.replaceState({}, document.title, window.location.pathname);
            document.getElementById('status').innerText = "集點完成";
          } else if (data.action === "draw") {
            alert("恭喜獲得： " + response.prize + "！");
            // 抽完獎自動重整歷史紀錄
            loadHistory(); 
          } else if (data.action === "getHistory") {
             // 渲染歷史紀錄
             renderHistory(response.history);
          }
        } else {
          // 2. 如果是 Error (例如代碼重複)，alert 錯誤訊息，但上面已經更新過點數了
          alert(response.message);
          document.getElementById('status').innerText = response.message;
        }
      })
      .catch(err => {
        console.error(err);
      });
    }

    // 新增：讀取歷史紀錄
    function loadHistory() {
      document.getElementById('status').innerText = "讀取紀錄中...";
      callApi({ action: "getHistory", userId: currentUserId });
    }

    // 新增：顯示歷史紀錄到畫面上
    function renderHistory(historyArray) {
      const listDiv = document.getElementById('historyList');
      const ul = document.getElementById('historyUl');
      ul.innerHTML = ""; // 清空舊資料
      
      if (historyArray.length === 0) {
        ul.innerHTML = "<li>尚無紀錄</li>";
      } else {
        historyArray.forEach(item => {
          // 顯示格式： [集點] 2023/10/01 - 掃描代碼 A123
          let color = item.type === "抽獎" ? "red" : "green";
          let li = document.createElement("li");
          li.innerHTML = `<span style="color:${color}; font-weight:bold;">[${item.type}]</span> ${item.date}<br><small>${item.detail}</small>`;
          li.style.marginBottom = "10px";
          li.style.borderBottom = "1px solid #eee";
          ul.appendChild(li);
        });
      }
      
      listDiv.style.display = "block"; // 顯示區塊
      document.getElementById('status').innerText = "紀錄讀取完畢";
    }

    // ... (updateUI, drawPrize 保持不變) ...
</script>
