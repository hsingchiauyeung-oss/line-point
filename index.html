<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›†é»å¡é™¤éŒ¯ç‰ˆ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .btn { padding: 15px; font-size: 18px; background: #ddd; margin: 10px; display: block; width: 80%; margin: 10px auto; }
        #debug-console { text-align: left; background: #f0f0f0; padding: 10px; margin-top: 20px; border: 1px solid #999; font-size: 12px; }
    </style>
</head>
<body>
    <h2>é›†é»å¡é™¤éŒ¯æ¨¡å¼</h2>
    <div id="status">æº–å‚™ä¸­...</div>
    <div id="debug-console">æ—¥èªŒå°‡é¡¯ç¤ºåœ¨æ­¤...</div>

    <script>
        // === è«‹å‹™å¿…æª¢æŸ¥é€™è£¡æœ‰æ²’æœ‰å¡«å° ===
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbx-DjbmDFNzGqFQwQS7K_SkBftnzFS28M_ZbUP7eE_RjgEk8F016slDfi-PFz6DOiCeSA/exec'; 
        const MY_LIFF_ID = '2009031692-gSna9Z1E';
        // ==============================

        // è¼”åŠ©å‡½å¼ï¼šæŠŠè¨Šæ¯å°åœ¨ç•«é¢ä¸Šï¼Œæ–¹ä¾¿æ‰‹æ©ŸæŸ¥çœ‹
        function log(msg) {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.innerHTML += "<br>" + msg;
            document.getElementById('status').innerText = msg;
        }

        // --- æª¢æŸ¥ç«™ 1: ç¨‹å¼ç¢¼æœ‰æ²’æœ‰è·‘èµ·ä¾† ---
        alert('æª¢æŸ¥ç«™ 1: ç¶²é è®€å–æˆåŠŸ');
        log('æª¢æŸ¥ç«™ 1 é€šé');

        window.onload = function() {
            log('æº–å‚™å•Ÿå‹• LIFF...');
            
            if (!MY_LIFF_ID) {
                alert('éŒ¯èª¤ï¼šæ‚¨å¿˜è¨˜å¡«å¯« LIFF ID äº†ï¼');
                return;
            }

            // --- æª¢æŸ¥ç«™ 2: LIFF åˆå§‹åŒ– ---
            liff.init({ liffId: MY_LIFF_ID })
                .then(() => {
                    alert('æª¢æŸ¥ç«™ 2: LIFF åˆå§‹åŒ–æˆåŠŸ');
                    log('æª¢æŸ¥ç«™ 2 é€šéï¼Œæº–å‚™ç™»å…¥...');
                    
                    if (!liff.isLoggedIn()) {
                        log('å°šæœªç™»å…¥ï¼Œè½‰è·³ç™»å…¥é é¢...');
                        liff.login();
                    } else {
                        liff.getProfile().then(profile => {
                            const userId = profile.userId;
                            alert('æª¢æŸ¥ç«™ 3: æŠ“åˆ° UserID äº†\n' + userId);
                            log('æŠ“åˆ° UserID: ' + userId);
                            
                            // é€™è£¡æ‰é–‹å§‹çœŸæ­£é€£ç·š Google
                            log('é–‹å§‹é€£ç·š Google Sheet...');
                            testConnection(userId);
                        });
                    }
                })
                .catch(err => {
                    alert('âŒ LIFF åˆå§‹åŒ–å¤±æ•—ï¼\nä»£ç¢¼ï¼š' + err.code + '\nè¨Šæ¯ï¼š' + err.message);
                    log('LIFF Error: ' + err);
                });
        };

       function testConnection(userId) {
            // æ¸¬è©¦é€£ç·š
            fetch(GAS_URL + '?action=check&userId=' + userId)
            .then(response => {
                // å…ˆæª¢æŸ¥ç¶²è·¯ç‹€æ…‹æ˜¯ä¸æ˜¯ 200 OK
                if (!response.ok) {
                    throw new Error("ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: " + response.status);
                }
                // é€™è£¡ä¸è¦ç›´æ¥è½‰ jsonï¼Œå…ˆè½‰ text çœ‹çœ‹å…§å®¹æ˜¯ä»€éº¼
                return response.text();
            })
            .then(text => {
                log('æ”¶åˆ°åŸå§‹è³‡æ–™: ' + text); // æŠŠæ”¶åˆ°çš„æ±è¥¿å°å‡ºä¾†çœ‹
                
                // å˜—è©¦æŠŠå®ƒè½‰æˆ JSON
                try {
                    const data = JSON.parse(text);
                    alert('ğŸ‰ çµ‚æ–¼æˆåŠŸäº†ï¼\n' + data.message);
                } catch (e) {
                    throw new Error("è³‡æ–™ä¸æ˜¯ JSON æ ¼å¼ï¼Œå¯èƒ½æ˜¯éŒ¯èª¤é é¢");
                }
            })
            .catch(error => {
                alert('âŒ é‚„æ˜¯å¤±æ•—ï¼š' + error);
                log('è©³ç´°éŒ¯èª¤: ' + error);
            });
        }
        }
    </script>
</body>
</html>


