<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>集點卡</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .btn { padding: 15px 30px; font-size: 18px; background: #00B900; color: white; border: none; border-radius: 10px; margin: 10px; cursor: pointer; }
        .btn-draw { background: #ff5722; }
        #status { margin-top: 20px; font-size: 20px; color: #333; }
    </style>
</head>
<body>
    <h1>我的集點卡</h1>
    <p>目前點數：<span id="points">讀取中...</span></p>
    
    <button class="btn" onclick="addPoint()">打卡集點 (+1)</button>
    <br>
    <button class="btn btn-draw" onclick="drawPrize()">消耗10點抽獎</button>

    <div id="status"></div>

    <script>
        // ----------------------------------------------------
        // 請把下面的網址換成您剛剛在 Google Apps Script 複製的網址
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzVIIzzvQReLkZS8yKIuRfeXC2L5ZiE_C9VUPceGO0p-7WSVuhgd7G70fmxLUKNK5YkBw/exec';
        
        // 請填入您的 LIFF ID (在 LINE Developers 後台看)
        const MY_LIFF_ID = '2009031692-gSna9Z1E';
        // ----------------------------------------------------

        let userLineId = "";

        // 1. 網頁一打開，先連線 LINE 取得這是誰
        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID })
                .then(() => {
                    if (liff.isLoggedIn()) {
                        liff.getProfile().then(profile => {
                            userLineId = profile.userId;
                            checkPoints(); // 登入後馬上查點數
                        });
                    } else {
                        liff.login();
                    }
                })
                .catch(err => {
                    document.getElementById("status").innerText = "LIFF 初始化失敗：" + err;
                });
        };

        // 2. 呼叫 GAS 店員的函式
        function callGas(action) {
            document.getElementById("status").innerText = "連線中...";
            
            // 透過 fetch 把指令傳給 Google
            fetch(GAS_URL + '?action=' + action + '&userId=' + userLineId, {
                method: "GET",
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("points").innerText = data.points;
                document.getElementById("status").innerText = data.msg;
                if(data.status === 'success' && action === 'draw') {
                    alert(data.msg); // 抽獎成功跳視窗
                }
            })
            .catch(error => {
    // 把錯誤印出來給你看
    alert("錯誤原因：" + error); 
    console.log(error); // 如果你會用電腦瀏覽器的 F12 看
    document.getElementById("status").innerText = "連線錯誤：" + error;
});
        }

        // 按鈕功能
        function checkPoints() { callGas('check'); }
        function addPoint() { callGas('add'); }
        function drawPrize() { callGas('draw'); }

    </script>
</body>
</html>

