<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LINE é›†é» & æŠ½ç</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>LINE é›†é» & æŠ½ç Demo</h2>

  <div>
    <label>åºè™Ÿï¼š</label>
    <input type="text" id="codeInput" placeholder="æƒææˆ–è¼¸å…¥åºè™Ÿ">
    <button id="scanBtn">æƒæ QR Code</button>
    <button id="pointBtn">é›†é»</button>
  </div>

  <p id="status"></p>
  <p id="result"></p>
  <button id="lotteryBtn" style="display:none;">ğŸ æˆ‘è¦æŠ½ç</button>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/ä½ çš„GAS_ID/exec"; // æ”¹æˆä½ çš„ Web App URL
    const LIFF_ID = "ä½ çš„LIFF_ID"; // æ”¹æˆä½ çš„ LIFF ID

    async function init() {
      await liff.init({ liffId: LIFF_ID });
    }

    init();

    // æƒæ QR Codeï¼Œè‡ªå‹•å¡«å…¥åºè™Ÿ
    document.getElementById("scanBtn").onclick = async () => {
      try {
        const result = await liff.scanCodeV2();
        document.getElementById("codeInput").value = result.value.trim();
      } catch (err) {
        alert("æƒæå¤±æ•—æˆ–å–æ¶ˆ");
      }
    };

    // é›†é»æŒ‰éˆ•
    document.getElementById("pointBtn").onclick = async () => {
      const code = document.getElementById("codeInput").value.trim();
      if (!code) return alert("è«‹è¼¸å…¥æˆ–æƒæåºè™Ÿ");

      document.getElementById("status").innerText = "é›†é»ä¸­...";

      const res = await fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify({
          code: code,
          lineUserId: liff.getContext().userId
        })
      });

      const data = await res.json();
      document.getElementById("result").innerText = data.message;
      document.getElementById("status").innerText = "";

      const match = data.message.match(/ç›®å‰ (\d+) é»/);
      if (match && parseInt(match[1]) >= 10) {
        document.getElementById("lotteryBtn").style.display = "block";
      } else {
        document.getElementById("lotteryBtn").style.display = "none";
      }
    };

    // æŠ½çæŒ‰éˆ•
    document.getElementById("lotteryBtn").onclick = async () => {
      document.getElementById("status").innerText = "æŠ½çä¸­...";

      const res = await fetch(GAS_URL + "?action=lottery&lineUserId=" + liff.getContext().userId);
      const data = await res.json();

      document.getElementById("result").innerText = data.message;
      document.getElementById("status").innerText = "";

      // æŠ½å®Œè‡ªå‹•éš±è—æŒ‰éˆ•
      document.getElementById("lotteryBtn").style.display = "none";
    };
  </script>
</body>
</html>
