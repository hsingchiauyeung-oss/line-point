<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¹¸é‹é›†é»å¡</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* === 1. åŸºç¤æ¨£å¼ === */
    body { font-family: sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; text-align: center; color: #333; overflow-x: hidden; }
    .card { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; position: relative; z-index: 1;}
    h2 { margin: 0; font-size: 18px; color: #666; }
    #points { font-size: 64px; font-weight: bold; color: #00B900; margin: 10px 0; line-height: 1; transition: transform 0.2s; }
    
    /* === 2. æŒ‰éˆ• === */
    .btn { display: block; width: 100%; padding: 15px 0; border-radius: 50px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    .btn-draw { background-color: #ff9800; color: white; }
    .btn-draw:disabled { background-color: #ccc; cursor: not-allowed; }
    .btn-history { background-color: #e4e6eb; color: #333; }
    .btn-redeem { background: #00B900; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 14px; cursor: pointer; }
    
    /* === 3. æ­·å²ç´€éŒ„èˆ‡ç‹€æ…‹ === */
    .status-claimed { color: #999; font-size: 12px; background: #eee; padding: 4px 8px; border-radius: 4px;}
    #historySection { margin-top: 25px; text-align: left; display: none; border-top: 1px solid #eee; padding-top: 20px; }
    .history-item { padding: 15px 0; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
    .tag { padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right:5px; }
    .tag-scan { background: #e6f7ff; color: #1890ff; }
    .tag-draw { background: #fff1f0; color: #f5222d; }
    .time { font-size: 12px; color: #999; display:block; margin-top:2px; }

    /* === 4. è½‰ç›¤æ¨¡çµ„ === */
    #wheelModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    #pointer { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid #ff3333; z-index: 10; }
    #wheelStatus { color: white; font-size: 22px; font-weight: bold; margin-top: 20px; }

    /* === 5. è“‹ç« å‹•ç•« (æƒç¢¼å°ˆç”¨) === */
    #scanOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; transition: opacity 0.5s; }
    .ticket { background: white; width: 300px; height: 180px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 2px dashed #ccc; }
    .ticket-dots { display: flex; gap: 8px; margin-top: 10px;}
    .dot { width: 12px; height: 12px; background: #eee; border-radius: 50%; animation: blink 1.5s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    
    .stamp-mark { 
        position: absolute; width: 140px; height: 140px; border: 5px solid #d32f2f; border-radius: 50%; 
        color: #d32f2f; font-size: 40px; font-weight: 900; display: flex; align-items: center; justify-content: center; 
        transform: scale(3); opacity: 0; pointer-events: none; text-shadow: 2px 2px 0px rgba(255,255,255,0.5);
        background: rgba(255, 255, 255, 0.9);
    }
    .stamp-active { animation: stamp-slam 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    @keyframes blink { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
    @keyframes stamp-slam { 0% { transform: scale(3) rotate(-15deg); opacity: 0; } 100% { transform: scale(1) rotate(-15deg); opacity: 1; } }

    /* === 6. æ ¸éŠ·ç¢¼å½ˆçª— === */
    #redeemModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .redeem-box { background: white; width: 85%; max-width: 320px; padding: 30px; border-radius: 16px; text-align: center; }
    .code-display { font-size: 28px; font-weight: bold; color: #333; background: #f0f2f5; padding: 15px; margin: 20px 0; border-radius: 8px; letter-spacing: 2px; border: 2px dashed #ccc; }
    .close-btn { background: #666; color: white; padding: 10px 30px; border-radius: 50px; border: none; cursor: pointer; }

    /* è®€å–ä¸­ */
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 4000; font-weight: bold; flex-direction: column;}
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading"><div>ç³»çµ±é€£ç·šä¸­...</div></div>

  <div id="scanOverlay" class="hidden">
    <div class="ticket">
      <div style="font-size:18px; color:#666;">ç¥¨åˆ¸é©—è­‰ä¸­...</div>
      <div class="ticket-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <div id="stampEffect" class="stamp-mark">GET!</div>
    </div>
  </div>

  <div id="wheelModal">
    <div style="position: relative; margin-bottom: 20px;">
      <div id="pointer"></div>
      <canvas id="wheelCanvas" width="320" height="320"></canvas>
    </div>
    <div id="wheelStatus">è½‰å‹•ä¸­...</div>
  </div>

  <div id="redeemModal">
    <div class="redeem-box">
      <h3 style="margin-top:0;">ğŸ‰ å…Œæ›æˆåŠŸï¼</h3>
      <p>è«‹å°‡æ­¤ä»£ç¢¼æˆªåœ–å‚³çµ¦å®¢æœ</p>
      <div class="code-display" id="myRedeemCode">...</div>
      <button class="close-btn" onclick="closeRedeemModal()">é—œé–‰</button>
    </div>
  </div>

  <div class="card">
    <h2>ç›®å‰ç´¯ç©é»æ•¸</h2>
    <div id="points">--</div>
    
    <button id="btnDraw" class="btn btn-draw" disabled onclick="handleDrawClick()">ğŸ° æ¶ˆè€— 10 é»è½‰ç›¤æŠ½ç</button>
    <button class="btn btn-history" onclick="toggleHistory()">æŸ¥çœ‹æ­·å²èˆ‡çå“</button>

    <div id="historySection">
      <h3 style="font-size:16px; margin-bottom:10px;">ç´€éŒ„èˆ‡çå“</h3>
      <div id="historyList"></div>
    </div>
  </div>

  <script>
    // ==========================================
    // â˜… è¨­å®šå€ (å¡«å…¥ä½ çš„ ID)
    // ==========================================
    const LIFF_ID = "2009057632-82QgHeXo"; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxyLQqmU0j493lUYa477L4VNTQJ41mTxl3hNYLk9NmiO2pwnHewPTmQrIUuZHi2f5P5YQ/exec"; 
    // ==========================================

    let currentUserId = null;
    let currentPoints = 0;

    // è½‰ç›¤è¨­å®š
    const prizes = ["Aè³", "Bè³", "Cè³"]; 
    const colors = ["#FF6384", "#36A2EB", "#FFCE56"];
    let startAngle = 0;
    let arc = Math.PI / (prizes.length / 2);
    let ctx;
    let isSpinning = false;
    let spinFrameId = null;
    let spinSpeed = 0;
    let targetAngle = -1;
    let finalPrizeForAlert = "";

    // 1. åˆå§‹åŒ–
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) liff.login();
      else {
        liff.getProfile().then(profile => {
          currentUserId = profile.userId;
          mainLogic();
          drawRouletteWheel();
        });
      }
    }).catch(err => {
      alert("LIFF å•Ÿå‹•å¤±æ•—");
      document.getElementById('loading').classList.add('hidden');
    });

    function mainLogic() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      
      if (code) {
        // æƒç¢¼æ¨¡å¼ï¼šéš±è—æ™®é€š Loadingï¼Œé¡¯ç¤ºè“‹ç« é®ç½©
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('scanOverlay').classList.remove('hidden');
        callBackend("scan", { code: code });
        window.history.replaceState({}, document.title, window.location.pathname);
      } else {
        callBackend("init", {});
      }
    }

    // 2. å‘¼å«å¾Œç«¯
    function callBackend(action, payload) {
      const data = { action: action, userId: currentUserId, ...payload };
      
      // åªæœ‰åˆå§‹åŒ–æ‰é¡¯ç¤ºç™½åº• Loading
      if(action === 'init') document.getElementById('loading').classList.remove('hidden');

      fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(text => JSON.parse(text))
      .then(response => {
        if(action === 'init') document.getElementById('loading').classList.add('hidden');

        if (response.status === "fatal_error") {
            if(action === 'scan') { alert(response.message); document.getElementById('scanOverlay').classList.add('hidden'); }
            else if(action === 'draw') stopWheelError();
            else alert("éŒ¯èª¤ï¼š" + response.message);
            return;
        }

        if (response.points !== undefined) {
             if(action !== 'scan') { currentPoints = response.points; updateUI(response.points); }
        }
        if (response.history !== undefined) renderHistory(response.history);

        // --- å‹•ä½œåˆ†æµ ---
        if (action === "scan") {
            if(response.status === 'success') playStampAnimation(response.points);
            else { alert(response.message); document.getElementById('scanOverlay').classList.add('hidden'); }
        }
        else if (action === "redeem") showRedeemCode(response);
        else if (action === "draw") {
          if (response.status === "success") calculateStopAngle(response.prize);
          else { alert(response.message); stopWheelError(); }
        }
      })
      .catch(err => {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('scanOverlay').classList.add('hidden');
        if(action === 'draw') stopWheelError();
        alert("é€£ç·šå¤±æ•—ï¼š" + err.message);
      });
    }

    // --- è“‹ç« ç‰¹æ•ˆ ---
    function playStampAnimation(newPoints) {
        const stamp = document.getElementById('stampEffect');
        stamp.classList.add('stamp-active');
        if (navigator.vibrate) navigator.vibrate(50);

        setTimeout(() => {
            document.getElementById('scanOverlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('scanOverlay').classList.add('hidden');
                document.getElementById('scanOverlay').style.opacity = '1';
                stamp.classList.remove('stamp-active');
                
                // æ•¸å­—æ»¾å‹•
                animateValue("points", currentPoints, newPoints, 1000);
                currentPoints = newPoints;
                updateUI(newPoints);
            }, 500);
        }, 1500);
    }

    function animateValue(id, start, end, duration) {
        if (start === end) return;
        const range = end - start;
        let current = start;
        const increment = end > start ? 1 : -1;
        const stepTime = Math.abs(Math.floor(duration / range));
        const obj = document.getElementById(id);
        const timer = setInterval(function() {
            current += increment;
            obj.innerHTML = current;
            obj.style.transform = "scale(1.2)";
            setTimeout(() => obj.style.transform = "scale(1)", 100);
            if (current == end) clearInterval(timer);
        }, Math.max(stepTime, 50));
    }

    // --- è½‰ç›¤é‚è¼¯ (é›¶å»¶é²) ---
    function handleDrawClick() {
        if (currentPoints < 10) return alert("é»æ•¸ä¸è¶³ï¼");
        if (!confirm("ç¢ºå®šæ¶ˆè€— 10 é»æŠ½çï¼Ÿ")) return;

        document.getElementById('wheelModal').style.display = "flex";
        isSpinning = true;
        spinSpeed = 0.5;
        targetAngle = -1;
        animateWheel(); 
        callBackend("draw", {}); 
    }

    function animateWheel() {
        if (!isSpinning) return;
        if (targetAngle === -1) {
            spinSpeed = 0.5;
        } else {
            let delta = targetAngle - startAngle;
            if (delta < 0) delta += Math.PI * 20;
            spinSpeed = delta * 0.05; 
            if (spinSpeed < 0.005) {
                isSpinning = false;
                startAngle = targetAngle;
                drawRouletteWheel();
                setTimeout(() => {
                    alert("ğŸ‰ æ­å–œç²å¾—ï¼š" + finalPrizeForAlert + "ï¼");
                    document.getElementById('wheelModal').style.display = "none";
                    callBackend("init", {}); 
                }, 500);
                return;
            }
        }
        startAngle += spinSpeed;
        if (startAngle > Math.PI * 2) startAngle -= Math.PI * 2;
        drawRouletteWheel();
        spinFrameId = requestAnimationFrame(animateWheel);
    }

    function calculateStopAngle(prizeName) {
        finalPrizeForAlert = prizeName;
        const prizeIndex = prizes.indexOf(prizeName);
        const degreePerSlice = (2 * Math.PI) / prizes.length;
        const prizeCenterRel = (prizeIndex * degreePerSlice) + (degreePerSlice / 2);
        let target = (1.5 * Math.PI) - prizeCenterRel;
        while (target < startAngle + (Math.PI * 6)) { target += Math.PI * 2; }
        const randomOffset = (Math.random() * 0.1) - 0.05;
        targetAngle = target + randomOffset;
    }

    function stopWheelError() {
        isSpinning = false;
        cancelAnimationFrame(spinFrameId);
        document.getElementById('wheelModal').style.display = "none";
    }

    function drawRouletteWheel() {
      const canvas = document.getElementById("wheelCanvas");
      if (!canvas.getContext) return;
      ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, 320, 320);
      
      for(let i = 0; i < prizes.length; i++) {
        const angle = startAngle + i * arc;
        ctx.fillStyle = colors[i];
        ctx.beginPath();
        ctx.arc(160, 160, 150, angle, angle + arc, false);
        ctx.arc(160, 160, 0, angle + arc, angle, true);
        ctx.fill();
        ctx.save();
        ctx.fillStyle = "white";
        ctx.font = 'bold 24px sans-serif';
        ctx.translate(160 + Math.cos(angle + arc / 2) * 110, 
                      160 + Math.sin(angle + arc / 2) * 110);
        ctx.rotate(angle + arc / 2 + Math.PI / 2);
        const text = prizes[i];
        ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
        ctx.restore();
      } 
    }

    // --- æ ¸éŠ· (ç›´æ¥é¡¯ç¤ºä»£ç¢¼) ---
    function showRedeemCode(response) {
        if (response.status === "success") {
            document.getElementById('myRedeemCode').innerText = response.code;
            document.getElementById('redeemModal').style.display = "flex";
        } else {
            alert(response.message);
        }
    }
    function closeRedeemModal() {
        document.getElementById('redeemModal').style.display = "none";
        callBackend("init", {}); 
    }

    // --- UI æ›´æ–° ---
    function updateUI(points) {
      document.getElementById('points').innerText = points;
      const btn = document.getElementById('btnDraw');
      if (points >= 10) {
        btn.disabled = false;
        btn.innerHTML = "ğŸ° æ¶ˆè€— 10 é»è½‰ç›¤æŠ½ç";
      } else {
        btn.disabled = true;
        btn.innerHTML = `é›†æ»¿ 10 é»å¯æŠ½ç<br><span style="font-size:14px">(é‚„å·® ${10 - points} é»)</span>`;
      }
    }

    function renderHistory(logs) {
      const listDiv = document.getElementById('historyList');
      listDiv.innerHTML = "";
      if (logs.length === 0) { listDiv.innerHTML = "<div style='color:#999; text-align:center;'>å°šç„¡ç´€éŒ„</div>"; return; }
      logs.forEach(log => {
        let actionArea = "";
        if (log.type === "æŠ½ç") {
          if (log.status === "Unclaimed") {
            actionArea = `<button class="btn-redeem" onclick="handleRedeem(${log.rowIndex})">é ˜ç</button>`;
          } else if (log.status === "Claimed") {
            actionArea = `<span class="status-claimed">å·²å…Œæ›</span>`;
          }
        }
        const tagClass = log.type === "é›†é»" ? "tag-scan" : "tag-draw";
        listDiv.innerHTML += `<div class="history-item"><div style="text-align:left;"><span class="tag ${tagClass}">${log.type}</span><span style="font-weight:500;">${log.msg}</span><span class="time">${log.date}</span></div><div>${actionArea}</div></div>`;
      });
    }

    function handleRedeem(rowIndex) {
      if (confirm("ç¢ºå®šè¦å…Œæ›å—ï¼Ÿå°‡ç”¢ç”Ÿæ ¸éŠ·ä»£ç¢¼ã€‚")) {
        document.getElementById('loading').classList.remove('hidden');
        callBackend("redeem", { rowIndex: rowIndex });
      }
    }
    function toggleHistory() {
      const section = document.getElementById('historySection');
      section.style.display = (section.style.display === "block") ? "none" : "block";
    }
  </script>
</body>
</html>
