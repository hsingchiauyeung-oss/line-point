<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¹¸é‹é›†é»å¡</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* UI æ¨£å¼ */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; text-align: center; color: #333; }
    .card { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
    h2 { margin: 0; font-size: 18px; color: #666; }
    #points { font-size: 64px; font-weight: bold; color: #00B900; margin: 10px 0; line-height: 1; }
    
    .btn { display: block; width: 100%; padding: 15px 0; border-radius: 50px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.2s; }
    .btn-draw { background-color: #ff9800; color: white; box-shadow: 0 4px 0 #e68900; }
    .btn-draw:active { box-shadow: 0 2px 0 #e68900; transform: translateY(2px); }
    .btn-draw:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }
    .btn-history { background-color: #e4e6eb; color: #333; }
    .btn-redeem { background: #00B900; color: white; border: none; padding: 5px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; }
    
    .status-claimed { color: #999; font-size: 12px; }
    #historySection { margin-top: 25px; text-align: left; display: none; border-top: 1px solid #eee; padding-top: 20px; }
    .history-item { padding: 15px 0; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
    .tag { padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right:5px; }
    .tag-scan { background: #e6f7ff; color: #1890ff; }
    .tag-draw { background: #fff1f0; color: #f5222d; }
    .time { font-size: 12px; color: #999; display:block; margin-top:2px; }

    /* è½‰ç›¤æ¨£å¼ */
    #wheelModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
    #canvasContainer { position: relative; margin-bottom: 20px; }
    #pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #ff3333; z-index: 10; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
    #wheelStatus { color: white; font-size: 20px; font-weight: bold; margin-top: 10px; min-height: 30px;}

    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 2000; font-weight: bold; flex-direction: column;}
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading"><div>ç³»çµ±é€£ç·šä¸­...</div><div style="font-size:12px; color:#999; margin-top:5px;">è«‹ç¨å€™</div></div>

  <div id="wheelModal">
    <div id="canvasContainer">
      <div id="pointer"></div>
      <canvas id="wheelCanvas" width="300" height="300"></canvas>
    </div>
    <div id="wheelStatus">æº–å‚™æŠ½ç...</div>
  </div>

  <div class="card">
    <h2>ç›®å‰ç´¯ç©é»æ•¸</h2>
    <div id="points">--</div>
    
    <button id="btnDraw" class="btn btn-draw" disabled onclick="startDrawFlow()">
      ğŸ° æ¶ˆè€— 10 é»è½‰ç›¤æŠ½ç
    </button>
    <button class="btn btn-history" onclick="toggleHistory()">
      æŸ¥çœ‹æ­·å²èˆ‡çå“
    </button>

    <div id="historySection">
      <h3 style="font-size:16px; margin-bottom:10px;">ç´€éŒ„èˆ‡çå“</h3>
      <div id="historyList"></div>
    </div>
  </div>

  <script>
    // ==========================================
    // â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„è³‡æ–™
    // ==========================================
    const LIFF_ID = "2009057632-82QgHeXo"; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzckRiCmKtjI195NLubLjuQQ9g4t_nMSFqwfUZvxaFUoiHzrsmDxkZ7fxuNnuZAFwDjtQ/exec"; 
    const LINE_OA_ID = "@539gosmt"; // ä¾‹å¦‚ @123xyz
    // ==========================================

    let currentUserId = null;
    
    // è½‰ç›¤åƒæ•¸
    const prizes = ["Aè³", "Bè³", "Cè³"];
    const colors = ["#FF6384", "#36A2EB", "#FFCE56"];
    let startAngle = 0;
    let arc = Math.PI / (prizes.length / 2);
    let spinTimeout = null;
    let spinAngleStart = 10;
    let spinTime = 0;
    let spinTimeTotal = 0;
    let ctx;
    let finalPrize = "";

    // 1. LIFF åˆå§‹åŒ–
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        liff.getProfile().then(profile => {
          currentUserId = profile.userId;
          mainLogic();
          drawRouletteWheel(); 
        });
      }
    }).catch(err => {
      alert("LIFF åˆå§‹åŒ–å¤±æ•—");
      document.getElementById('loading').classList.add('hidden');
    });

    function mainLogic() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      if (code) {
        document.getElementById('loading').innerHTML = "é›†é»è™•ç†ä¸­...";
        callBackend("scan", { code: code });
        window.history.replaceState({}, document.title, window.location.pathname);
      } else {
        callBackend("init", {});
      }
    }

    // 2. å¾Œç«¯é€šè¨Š
    function callBackend(action, payload) {
      const data = { action: action, userId: currentUserId, ...payload };
      if(action !== 'draw') document.getElementById('loading').classList.remove('hidden');

      fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(text => JSON.parse(text))
      .then(response => {
        document.getElementById('loading').classList.add('hidden');
        if (response.status === "fatal_error") return alert("ç³»çµ±éŒ¯èª¤ï¼š" + response.message);

        if (response.points !== undefined) updateUI(response.points);
        if (response.history !== undefined) renderHistory(response.history);

        if (action === "scan") alert(response.message);
        else if (action === "redeem") handleRedeemResponse(response, payload.prizeName);
        else if (action === "draw") {
          if (response.status === "success") {
             finalPrize = response.prize; 
             startSpinAnimation(); // é–‹å§‹è½‰
          } else {
             alert(response.message);
             closeWheel();
          }
        }
      })
      .catch(err => {
        document.getElementById('loading').classList.add('hidden');
        alert("é€£ç·šå¤±æ•—ï¼š" + err.message);
        closeWheel();
      });
    }

    // 3. è½‰ç›¤èˆ‡å‹•ç•«
    function drawRouletteWheel() {
      const canvas = document.getElementById("wheelCanvas");
      if (!canvas.getContext) return;
      ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, 300, 300);
      ctx.strokeStyle = "white";
      ctx.lineWidth = 2;
      ctx.font = 'bold 24px sans-serif';

      const outsideRadius = 140;
      const textRadius = 100;
      const insideRadius = 0;
      
      for(let i = 0; i < prizes.length; i++) {
        const angle = startAngle + i * arc;
        ctx.fillStyle = colors[i];
        ctx.beginPath();
        ctx.arc(150, 150, outsideRadius, angle, angle + arc, false);
        ctx.arc(150, 150, insideRadius, angle + arc, angle, true);
        ctx.stroke();
        ctx.fill();
        ctx.save();
        ctx.fillStyle = "white";
        ctx.translate(150 + Math.cos(angle + arc / 2) * textRadius, 
                      150 + Math.sin(angle + arc / 2) * textRadius);
        ctx.rotate(angle + arc / 2 + Math.PI / 2);
        const text = prizes[i];
        ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
        ctx.restore();
      } 
    }

    function startDrawFlow() {
      if (!confirm("ç¢ºå®šè¦æ¶ˆè€— 10 é»é€²è¡Œè½‰ç›¤æŠ½çå—ï¼Ÿ")) return;
      document.getElementById('wheelModal').style.display = "flex";
      document.getElementById('wheelStatus').innerText = "é€£ç·šä¸­...";
      callBackend("draw", {}); 
    }

    function startSpinAnimation() {
      document.getElementById('wheelStatus').innerText = "ç¥ä½ å¥½é‹ï¼";
      spinAngleStart = Math.random() * 10 + 10;
      spinTime = 0;
      spinTimeTotal = Math.random() * 1000 + 4000;
      rotateWheel();
    }

    function rotateWheel() {
      spinTime += 30;
      if(spinTime >= spinTimeTotal) {
        stopRotateWheel();
        return;
      }
      const spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
      startAngle += (spinAngle * Math.PI / 180);
      drawRouletteWheel();
      spinTimeout = requestAnimationFrame(rotateWheel);
    }

    function stopRotateWheel() {
      cancelAnimationFrame(spinTimeout);
      setTimeout(() => {
        alert("ğŸ‰ æ­å–œç²å¾—ï¼š" + finalPrize + "ï¼");
        closeWheel();
        callBackend("init", {}); 
      }, 500);
    }

    function easeOut(t, b, c, d) {
      const ts = (t/=d)*t;
      const tc = ts*t;
      return b+c*(tc + -3*ts + 3*t);
    }

    function closeWheel() {
      document.getElementById('wheelModal').style.display = "none";
    }

    // 4. å…¶ä»– UI é‚è¼¯
    function updateUI(points) {
      document.getElementById('points').innerText = points;
      const btn = document.getElementById('btnDraw');
      if (points >= 10) {
        btn.disabled = false;
        btn.innerHTML = "ğŸ° æ¶ˆè€— 10 é»è½‰ç›¤æŠ½ç";
      } else {
        btn.disabled = true;
        btn.innerText = `é›†æ»¿ 10 é»å¯æŠ½ç (é‚„å·® ${10 - points} é»)`;
      }
    }

    function renderHistory(logs) {
      const listDiv = document.getElementById('historyList');
      listDiv.innerHTML = "";
      if (logs.length === 0) { listDiv.innerHTML = "<div style='color:#999; text-align:center;'>å°šç„¡ç´€éŒ„</div>"; return; }

      logs.forEach(log => {
        let actionArea = "";
        if (log.type === "æŠ½ç") {
          if (log.status === "Unclaimed") {
            actionArea = `<button class="btn-redeem" onclick="handleRedeem(${log.rowIndex}, '${log.msg}')">é ˜ç</button>`;
          } else if (log.status === "Claimed") {
            actionArea = `<span class="status-claimed">å·²å…Œæ›</span>`;
          }
        }
        const tagClass = log.type === "é›†é»" ? "tag-scan" : "tag-draw";
        const html = `
          <div class="history-item">
            <div style="text-align:left;">
              <span class="tag ${tagClass}">${log.type}</span>
              <span style="font-weight:500;">${log.msg}</span>
              <span class="time">${log.date}</span>
            </div>
            <div>${actionArea}</div>
          </div>`;
        listDiv.innerHTML += html;
      });
    }

    function handleRedeem(rowIndex, prizeName) {
      if (confirm(`ç¢ºå®šè¦å…Œæ›ã€${prizeName}ã€‘å—ï¼Ÿ\n\nç³»çµ±å°‡ç”¢ç”Ÿæ ¸éŠ·ç¢¼ï¼Œä¸¦å¼•å°æ‚¨å›å‚³çµ¦å®˜æ–¹å¸³è™Ÿã€‚`)) {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('loading').innerHTML = "ç”¢ç”Ÿæ ¸éŠ·ç¢¼ä¸­...";
        callBackend("redeem", { rowIndex: rowIndex, prizeName: prizeName });
      }
    }

    function handleRedeemResponse(response, prizeName) {
      if (response.status === "success") {
        const myCode = response.code; 
        const msgToSend = `æ‚¨å¥½ï¼Œæˆ‘è¦å…Œæ›çå“ï¼\nçé …ï¼š${prizeName}\næ ¸éŠ·ç¢¼ï¼š${myCode}\nè«‹å¹«æˆ‘å®‰æ’å‡ºè²¨ã€‚`;
        if(confirm(`å…Œæ›æˆåŠŸï¼\næ‚¨çš„æ ¸éŠ·ç¢¼æ˜¯ï¼š${myCode}\n\næ˜¯å¦ç«‹å³å‚³é€çµ¦å®˜æ–¹å¸³è™Ÿï¼Ÿ`)) {
           window.location.href = `https://line.me/R/oaMessage/${LINE_OA_ID}/?${encodeURIComponent(msgToSend)}`;
        }
      } else {
        alert(response.message);
      }
    }

    function toggleHistory() {
      const section = document.getElementById('historySection');
      section.style.display = (section.style.display === "block") ? "none" : "block";
    }
  </script>
</body>
</html>
