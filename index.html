<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„é›†é»å¡</title>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; text-align: center; color: #333; }
    .card { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
    h2 { margin: 0; font-size: 18px; color: #666; }
    #points { font-size: 64px; font-weight: bold; color: #00B900; margin: 10px 0; line-height: 1; }
    .btn { display: block; width: 100%; padding: 15px 0; border-radius: 50px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.2s; }
    .btn-draw { background-color: #00B900; color: white; }
    .btn-draw:disabled { background-color: #ccc; cursor: not-allowed; }
    .btn-history { background-color: #e4e6eb; color: #333; }
    #status { margin-top: 15px; font-size: 14px; color: #888; height: 20px; }
    
    /* æ­·å²ç´€éŒ„å€å¡Š */
    #historySection { margin-top: 25px; text-align: left; display: none; border-top: 1px solid #eee; padding-top: 20px; }
    .history-item { padding: 10px 0; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
    .tag { padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-right: 8px; }
    .tag-scan { background: #e6f7ff; color: #1890ff; }
    .tag-draw { background: #fff1f0; color: #f5222d; }
    .time { font-size: 12px; color: #999; }
    
    /* è¼‰å…¥é®ç½© */
    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 999; font-weight: bold; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading">ç³»çµ±è®€å–ä¸­...</div>

  <div class="card">
    <h2>ç›®å‰ç´¯ç©é»æ•¸</h2>
    <div id="points">--</div>
    
    <div id="status"></div>

    <button id="btnDraw" class="btn btn-draw" disabled onclick="handleDraw()">
      é›†æ»¿ 10 é»å¯æŠ½ç
    </button>

    <button class="btn btn-history" onclick="toggleHistory()">
      æŸ¥çœ‹æ­·å²ç´€éŒ„
    </button>

    <div id="historySection">
      <h3 style="font-size:16px; margin-bottom:10px;">æœ€è¿‘æ´»å‹•</h3>
      <div id="historyList">
        </div>
    </div>
  </div>

  <script>
    // ==========================================
    // è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡)
    // ==========================================
    const LIFF_ID = "2009057632-82QgHeXo"; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycby9aN8AM6dxnLIBObdkRQXisvPuHSY-2rb7A3OhN8hB5qlOlsNmgWWCgMI_-X2eZ7ALJQ/exec"; 
    // ==========================================

    let currentUserId = null;

    // 1. ç¨‹å¼å…¥å£ï¼šåˆå§‹åŒ– LIFF
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        liff.getProfile().then(profile => {
          currentUserId = profile.userId;
          mainLogic();
        });
      }
    }).catch(err => {
      alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼š" + err);
      document.getElementById('loading').classList.add('hidden');
    });

    // 2. ä¸»è¦é‚è¼¯ï¼šåˆ¤æ–·æ˜¯ã€Œæƒç¢¼ã€é‚„æ˜¯ã€Œå–®ç´”é–‹å•Ÿã€
    function mainLogic() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      if (code) {
        // æœ‰ code ä»£è¡¨æ˜¯æƒç¢¼é€²ä¾†çš„
        document.getElementById('loading').innerText = "é›†é»è™•ç†ä¸­...";
        callBackend("scan", { code: code });
        
        // æ¸…é™¤ç¶²å€ä¸Šçš„åƒæ•¸ï¼Œé¿å…é‡æ–°æ•´ç†é é¢æ™‚åˆé€ä¸€æ¬¡
        window.history.replaceState({}, document.title, window.location.pathname);
      } else {
        // æ²’æœ‰ code ä»£è¡¨æ˜¯ç”¨æˆ¶è‡ªå·±é»é€²ä¾†çœ‹çš„
        callBackend("init", {});
      }
    }

    // 3. å‘¼å«å¾Œç«¯ API
    function callBackend(action, payload) {
      const data = { action: action, userId: currentUserId, ...payload };
      
      fetch(GAS_URL, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(response => {
        document.getElementById('loading').classList.add('hidden'); // é—œé–‰é®ç½©
        
        // å¦‚æœæ˜¯åš´é‡éŒ¯èª¤
        if (response.status === "fatal_error") {
          alert("ç³»çµ±éŒ¯èª¤ï¼š" + response.message);
          return;
        }

        // æ›´æ–°ä»‹é¢ (é»æ•¸èˆ‡ç´€éŒ„)
        if (response.points !== undefined) updateUI(response.points);
        if (response.history !== undefined) renderHistory(response.history);

        // é‡å°ä¸åŒå‹•ä½œçš„åæ‡‰
        if (action === "scan") {
          if (response.status === "success") {
            alert(response.message); // é›†é»æˆåŠŸ
          } else {
            alert(response.message); // ä»£ç¢¼ç„¡æ•ˆæˆ–é‡è¤‡
          }
        } else if (action === "draw") {
           if (response.status === "success") {
             alert("ğŸ‰ " + response.message);
           } else {
             alert(response.message);
           }
        }
      })
      .catch(err => {
        document.getElementById('loading').classList.add('hidden');
        alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
      });
    }

    // 4. æ›´æ–°ç•«é¢ (é»æ•¸èˆ‡æŒ‰éˆ•ç‹€æ…‹)
    function updateUI(points) {
      document.getElementById('points').innerText = points;
      const btn = document.getElementById('btnDraw');
      
      if (points >= 10) {
        btn.disabled = false;
        btn.innerText = "ç«‹å³æŠ½ç (æ¶ˆè€—10é»)";
      } else {
        btn.disabled = true;
        btn.innerText = `é›†æ»¿ 10 é»å¯æŠ½ç (é‚„å·® ${10 - points} é»)`;
      }
    }

    // 5. æ¸²æŸ“æ­·å²ç´€éŒ„åˆ—è¡¨
    function renderHistory(logs) {
      const listDiv = document.getElementById('historyList');
      listDiv.innerHTML = "";
      
      if (logs.length === 0) {
        listDiv.innerHTML = "<div style='color:#999; text-align:center;'>å°šç„¡ç´€éŒ„</div>";
        return;
      }

      logs.forEach(log => {
        const tagClass = log.type === "é›†é»" ? "tag-scan" : "tag-draw";
        const html = `
          <div class="history-item">
            <div>
              <span class="tag ${tagClass}">${log.type}</span>
              <span>${log.msg}</span>
            </div>
            <div class="time">${log.date}</div>
          </div>
        `;
        listDiv.innerHTML += html;
      });
    }

    // 6. æŒ‰éˆ•äº‹ä»¶
    function handleDraw() {
      if (confirm("ç¢ºå®šè¦æ¶ˆè€— 10 é»é€²è¡ŒæŠ½çå—ï¼Ÿ")) {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('loading').innerText = "æŠ½çä¸­...";
        callBackend("draw", {});
      }
    }

    function toggleHistory() {
      const section = document.getElementById('historySection');
      if (section.style.display === "block") {
        section.style.display = "none";
      } else {
        section.style.display = "block";
      }
    }
  </script>
</body>
</html>



