<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>LINE é›†é» & æŠ½ç</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>LINE é›†é» & æŠ½ç Demo</h2>

  <div>
    <label>åºè™Ÿï¼š</label>
    <input type="text" id="codeInput" placeholder="æƒææˆ–è¼¸å…¥åºè™Ÿ">
    <button id="scanBtn">æƒæ QR Code</button>
  </div>

  <p id="status"></p>
  <p id="result"></p>
  <button id="lotteryBtn" style="display:none;">ğŸ æˆ‘è¦æŠ½ç</button>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzVIIzzvQReLkZS8yKIuRfeXC2L5ZiE_C9VUPceGO0p-7WSVuhgd7G70fmxLUKNK5YkBw/exec"; // Apps Script URL
    const LIFF_ID = "2009031692-gSna9Z1E"; // LIFF ID

    async function init(){ await liff.init({ liffId: LIFF_ID }); }
    init();

    // æƒ QR code â†’ è‡ªå‹•é›†é»
    document.getElementById("scanBtn").onclick = async ()=>{
      try{
        const result = await liff.scanCodeV2();
        const code = result.value.trim();
        document.getElementById("codeInput").value = code;
        document.getElementById("status").innerText = "é›†é»ä¸­...";

        const res = await fetch(GAS_URL,{
          method:"POST",
          body:JSON.stringify({ code, lineUserId: liff.getContext().userId })
        });
        const data = await res.json();
        document.getElementById("result").innerText = data.message;
        document.getElementById("status").innerText = "";

        // é¡¯ç¤ºæŠ½çæŒ‰éˆ•
        const match = data.message.match(/ç›®å‰ (\d+) é»/);
        if(match && parseInt(match[1])>=10){
          document.getElementById("lotteryBtn").style.display="block";
        }else{
          document.getElementById("lotteryBtn").style.display="none";
        }

      }catch(err){
        console.error(err);
        document.getElementById("status").innerText="";
        document.getElementById("result").innerText="é›†é»å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
      }
    };

    // æŠ½çæŒ‰éˆ•
    document.getElementById("lotteryBtn").onclick = async ()=>{
      document.getElementById("status").innerText = "æŠ½çä¸­...";
      try{
        const res = await fetch(GAS_URL+"?action=lottery&lineUserId="+liff.getContext().userId);
        const data = await res.json();
        document.getElementById("result").innerText = data.message;
      }catch(err){
        console.error(err);
        document.getElementById("result").innerText="æŠ½çå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
      }
      document.getElementById("status").innerText = "";

      // å‰©é¤˜é»æ•¸ â‰¥10 â†’ æŒ‰éˆ•å¯å†æ¬¡æŠ½
      const match = document.getElementById("result").innerText.match(/å‰©é¤˜é»æ•¸ï¼š(\d+)/);
      if(match && parseInt(match[1])>=10){
        document.getElementById("lotteryBtn").style.display="block";
      }else{
        document.getElementById("lotteryBtn").style.display="none";
      }
    };
  </script>
</body>
</html>

